# 專案檔案結構規劃

## 目錄結構
```
trading_system/
├── main.py                          # 主程式入口
├── config/
│   ├── __init__.py
│   └── config_loader.py             # opds.ini 載入
├── backend/
│   ├── __init__.py
│   ├── core.py                      # TradingBackend 核心類別(簡化版)
│   ├── auth.py                      # 登入/登出/CA憑證
│   ├── positions.py                 # 取得倉位、計算Delta、P&L
│   ├── orders.py                    # 平倉、建倉、全部平倉
│   ├── futures_management.py        # 期貨轉倉、價差計算
│   ├── options_management.py        # 選擇權更換標的
│   ├── subscription.py              # 訂閱報價、處理回調
│   └── contract_utils.py            # 合約查找、到期日計算
├── gui/
│   ├── __init__.py
│   ├── main_window.py               # 主視窗(包含UI框架)
│   ├── positions_table.py           # 倉位表格與右鍵選單
│   ├── dialogs/
│   │   ├── __init__.py
│   │   ├── futures_roll_dialog.py   # 期貨轉倉對話框
│   │   ├── options_change_dialog.py # 選擇權更換對話框
│   │   ├── new_position_dialog.py   # 建倉對話框
│   │   └── monitor_window.py        # 價差監測視窗
│   └── event_handlers.py            # GUI 事件處理(報價更新、刷新等)
└── utils/
    ├── __init__.py
    ├── margin_fetcher.py            # 原有的保證金模組
    └── helpers.py                   # 共用工具函數

## 各檔案職責說明

### main.py
- 程式入口點
- 初始化 GUI 並啟動主循環

### backend/core.py
- TradingBackend 類別(簡化版)
- 只保留初始化和 API 物件
- 其他功能委派給各子模組

### backend/auth.py
- login()
- logout()
- CA 憑證載入

### backend/positions.py
- get_positions()
- calculate_suggestion()
- get_underlying_price()
- _identify_option_type()
- _calculate_bs_delta_direct()
- _calculate_days_left()

### backend/orders.py
- close_position()
- close_all_positions()
- open_position()

### backend/futures_management.py
- roll_futures()
- get_futures_spread()
- check_and_roll_if_spread_met()
- _find_next_month_contract()

### backend/options_management.py
- change_option_by_code()
- change_option_by_code_with_price()
- get_five_quote()

### backend/subscription.py
- start_subscribing()
- 報價回調函數

### backend/contract_utils.py
- _find_contract_robust()
- _get_mxf_contract()
- _get_market_ref_price_fallback()
- _get_multiplier()
- _parse_expiry_from_code()
- _find_nth_wednesday()

### gui/main_window.py
- TradingApp 類別
- setup_ui() - UI 框架
- load_credentials()
- toggle_auth()
- 主要按鈕回調

### gui/positions_table.py
- refresh_positions()
- on_double_click()
- on_right_click()
- update_delta_display()
- update_totals()

### gui/dialogs/futures_roll_dialog.py
- 期貨轉倉對話框類別
- 立即轉倉 / 價差監測選項
- 當前價差查詢

### gui/dialogs/options_change_dialog.py
- 選擇權更換標的對話框
- 候選標的管理
- 五檔報價顯示

### gui/dialogs/monitor_window.py
- show_monitor_status_window()
- update_monitor_display()
- stop_all_monitors()
- 價差監測表格

### gui/dialogs/new_position_dialog.py
- open_new_position() 對話框

### gui/event_handlers.py
- on_quote_update()
- on_order_update()
- toggle_subscription()
- check_subscription_status()

## 模組間依賴關係

```
main.py
  └── gui/main_window.py
       ├── backend/core.py (聚合所有 backend 子模組)
       │    ├── backend/auth.py
       │    ├── backend/positions.py
       │    ├── backend/orders.py
       │    ├── backend/futures_management.py
       │    ├── backend/options_management.py
       │    ├── backend/subscription.py
       │    └── backend/contract_utils.py
       ├── gui/positions_table.py
       ├── gui/dialogs/*
       ├── gui/event_handlers.py
       └── utils/margin_fetcher.py

```

## 優點

1. **單一職責**: 每個模組負責明確的功能
2. **易於測試**: 可以獨立測試每個模組
3. **降低耦合**: 模組間透過明確的接口溝通
4. **方便維護**: 修改某功能只需編輯對應模組
5. **避免訊息限制**: 每個檔案都在合理長度
6. **清晰的組織**: 依功能分類,容易找到相關程式碼

## 實施步驟

1. 先建立目錄結構和 __init__.py
2. 從 backend 開始拆分(因為 backend 依賴少)
3. 拆分 GUI 模組
4. 更新 import 語句
5. 測試每個模組的功能
6. 整合測試

## 注意事項

- 所有 backend 子模組都需要訪問 self.api,可以透過參數傳遞或在 core.py 中初始化
- GUI 子模組需要訪問 backend 和 root,同樣透過參數傳遞
- 共用的工具函數放在 utils/helpers.py
- 保持每個檔案在 200-400 行左右